(function(e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e()}else if(typeof define==="function"&&define.amd){define([],e)}else{var t;if(typeof window!=="undefined"){t=window}else if(typeof global!=="undefined"){t=global}else if(typeof self!=="undefined"){t=self}else{t=this}t.StorageDb=e()}})(function(){var e,t,r;return function o(e,t,r){function i(s,a){if(!t[s]){if(!e[s]){var u=typeof require=="function"&&require;if(!a&&u)return u(s,!0);if(n)return n(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var l=t[s]={exports:{}};e[s][0].call(l.exports,function(t){var r=e[s][1][t];return i(r?r:t)},l,l.exports,o,e,t,r)}return t[s].exports}var n=typeof require=="function"&&require;for(var s=0;s<r.length;s++)i(r[s]);return i}({1:[function(e,t,r){var o=e("./StorageDb.js");function i(){throw new Error("Use Collection.create() instead.")}t.exports=i;i.create=function n(e,t){if(!o.checkKey(t)){throw new Error("Invalid collection name: "+t)}var r=Object.create(i.prototype,{storageDb:{value:e,enumerable:true},storage:{value:e.storage,enumerable:true},name:{value:t,enumerable:true},prefix:{value:e.prefix+o.keyDelimiter+t,enumerable:true},documents:{value:{},enumerable:true},cacheLoaded:{value:false,writable:true,enumerable:true}});if(!r.loadMeta()){r.saveMeta()}return r};i.prototype.loadMeta=function s(){var e,t,r;e=this.storage.getItem(this.prefix);if(!e){return false}try{e=JSON.parse(e)}catch(o){return false}for(t=0,r=e.documentKeys.length;t<r;t++){this.documents[e.documentKeys[t]]=undefined}if(this.storageDb.autoCacheCount){this.asyncCacheLoad(e.documentKeys)}return true};i.prototype.saveMeta=function a(){this.storage.setItem(this.prefix,JSON.stringify({documentKeys:Object.keys(this.documents)}))};i.prototype.get=function u(e){var t,r;if(!(e in this.documents)){console.log("Get: unexistant document");return undefined}if(this.documents[e]!==undefined){console.log("Get: document cached");this.storageDb.cacheHit++;return this.documents[e]}console.log("Get: document not cached");this.storageDb.cacheMiss++;t=this.prefix+o.keyDelimiter+e;r=this.storage.getItem(t);if(r===null){return undefined}try{r=JSON.parse(r)}catch(i){this.storage.removeItem(t);return undefined}this.documents[e]=r;return r};i.prototype.set=function c(e,t,r){var i;i=this.prefix+o.keyDelimiter+e;this.documents[e]=t;this.storage.setItem(i,JSON.stringify(t));if(!r){this.saveMeta()}};i.prototype.delete=function l(e,t){var r;if(!(e in this.documents)){console.log("Delete: unexistant document");return}r=this.prefix+o.keyDelimiter+e;delete this.documents[e];this.storage.removeItem(r);if(!t){this.saveMeta()}};i.prototype.drop=function f(e){var t,r,o;t=Object.keys(this.documents);for(r=0,o=t.length;r<o;r++){this.delete(t[r],true)}this.storage.removeItem(this.prefix);delete this.storageDb.collections[this.name];if(!e){this.storageDb.saveMeta()}};i.prototype.asyncCacheLoad=function h(e){var t,r,i,n,s,a,u=this.storageDb.autoCacheCount;for(t=0,a=0,r=e.length;t<r&&a<u;t++){i=e[t];if(this.documents[i]!==undefined){continue}n=this.prefix+o.keyDelimiter+i;s=this.storage.getItem(n);if(s!==null){try{s=JSON.parse(s);this.documents[i]=s}catch(c){this.storage.removeItem(n)}}a++}e=e.slice(t,e.length);if(!e.length){this.cacheLoaded=true;return}setTimeout(this.asyncCacheLoad.bind(this,e),0)}},{"./StorageDb.js":2}],2:[function(e,t,r){function o(){throw new Error("Use StorageDb.create() instead.")}t.exports=o;if(!o.isBrowser){o.LocalStorageEmu=e("./LocalStorageEmu.js")}var i=e("./Collection.js");o.Collection=i;o.keyDelimiter=";";o.create=function n(e,t,r){if(!o.checkKey(t)){throw new Error("Invalid DB name: "+t)}if(r===true){r=10}var i=Object.create(o.prototype,{storage:{value:e,enumerable:true},name:{value:t,enumerable:true},prefix:{value:o.keyDelimiter+t,enumerable:true},collections:{value:{},enumerable:true},autoCacheCount:{value:r,writable:true,enumerable:true},cacheHit:{value:0,writable:true,enumerable:true},cacheMiss:{value:0,writable:true,enumerable:true}});if(!i.loadMeta()){i.saveMeta()}return i};o.checkKey=function s(e){return e&&typeof e==="string"&&e.indexOf(o.keyDelimiter)===-1};o.prototype.loadMeta=function a(){var e,t,r;e=this.storage.getItem(this.prefix);if(!e){return false}try{e=JSON.parse(e)}catch(o){return false}console.log("db:",e);for(t=0,r=e.collections.length;t<r;t++){this.createCollection(e.collections[t])}return true};o.prototype.saveMeta=function u(){this.storage.setItem(this.prefix,JSON.stringify({collections:Object.keys(this.collections)}))};o.prototype.createCollection=function c(e){if(!o.checkKey(e)){throw new Error("Invalid collection name: "+e)}if(this.collections[e]){return this.collections[e]}this.collections[e]=i.create(this,e);this.saveMeta();return this.collections[e]};o.prototype.drop=function l(){var e,t,r;e=Object.keys(this.collections);for(t=0,r=e.length;t<r;t++){this.collections[e[t]].drop(true)}this.storage.removeItem(this.prefix)}},{"./Collection.js":1,"./LocalStorageEmu.js":undefined}],3:[function(e,t,r){t.exports=e("./StorageDb.js");t.exports.isBrowser=true},{"./StorageDb.js":2}]},{},[3])(3)});